<!doctype html>
<html>
<head>
<title>jsQuad Demo</title>
<script src='../jsQuad.js' type='text/javascript'></script>
<script>
window.onload = function() {
	var cv = document.getElementById('canvas');
	var ctx = cv.getContext('2d');
	
	var circles = [];
	var tree = new jsQuad(0,0,600,600,4);
	
	var red = new Image();
	red.src = 'redcircle.png';
	var black = new Image();
	black.src = 'blackcircle.png';
	
	// This is a fairly minimal implementation of an object class supported
	// by jsQuad
	var Circle = function(x, y, r, vx, vy) {
		this.x = x;
		this.y = y;
		this.r = r;
		this.vx = vx;
		this.vy = vy;
	};
	Circle.prototype = {
		move: function(dt) {
			this.x += this.vx * dt;
			this.y += this.vy * dt;
			// let's bounce!
			var ix = -(this.x-this.r);
			if (ix > 0) {
				this.vx = -this.vx;
				this.x += ix*2;
			} else {
				ix = this.x + this.r - 600;
				if (ix > 0) {
					this.vx = -this.vx;
					this.x -= ix*2;
				}
			}
			var iy = -(this.y-this.r);
			if (iy > 0) {
				this.vy = -this.vy;
				this.y += iy;
			} else {
				iy = this.y + this.r - 600;
				if (iy > 0) {
					this.vy = -this.vy;
					this.y -= iy;
				}
			}
			// after moving, update the tree
			tree.reinsert(this);
		},
		draw: function() {
			var img = black;
			var x = this.x, y = this.y, r = this.r;
			var touching = tree.getOverlapping(
				x-r,y-r,
				x+r,y+r
			);
			
			var len = touching.length;
			for (var i=0;i<len;i++) {
				var t = touching[i];
				if (touching[i] !== this) {
					var dx = x - t.x;
					var dy = y - t.y;
					var dr = r + t.r;
					if (dx*dx+dy*dy<=dr*dr) {
						img = red;
						break;
					}
				}
			}
			ctx.drawImage(img, x-r,y-r,r*2,r*2);
		},
		// jsQuad methods
		
		QTsetParent: function(parent) {
			this.QTparent = parent;
		},
		QTgetParent: function() {
			return this.QTparent;
		},
		QTenclosed: function(xMin,yMin,xMax,yMax) {
			var x0 = this.x-this.r, x1 = this.x+this.r;
			var y0 = this.y-this.r, y1 = this.y+this.r;
			return x0 >= xMin && x1 <= xMax && y0 >= yMin && y1 <= yMax;
		},
		QToverlaps: function(xMin,yMin,xMax,yMax) {
			var x0 = this.x-this.r, x1 = this.x+this.r;
			var y0 = this.y-this.r, y1 = this.y+this.r;
			return !(x1 < xMin || x0 > xMax || y1 < yMin || y0 > yMax);
		},
		QTquadrantNode: function(node, x, y) {
			var x0 = this.x-this.r, x1 = this.x+this.r;
			if (x0 > x) {
				var y0 = this.y-this.r, y1 = this.y+this.r;
				if (y0 > y) {
					return node.q1;
				} else if (y1 < y) {
					return node.q4;
				} else {
					return null;
				}
			} else if (x1 < x) {
				var y0 = this.y-this.r, y1 = this.y+this.r;
				if (y0 > y) {
					return node.q2;
				} else if (y1 < y) {
					return node.q3;
				} else {
					return null;
				}
			} else {
				return null;
			}
		},
	}; // Circle.prototype
	
	
	for (var i=0; i<1000; i++) {
		var circle = new Circle(
			Math.random()*520+40,
			Math.random()*520+40,
			Math.random()*5+2,
			Math.random()*200-100,
			Math.random()*200-100
		);
		circles.push(circle);
		tree.insert(circle);
	}
	var fpsCounter = document.getElementById('fps');
	var fps = 50;
	
	var prevTime = new Date();
	var loop = function() {
		var time = new Date();
		var dt = time - prevTime;
		prevTime = time;
		if (dt !== 0) {
			fps = fps*0.5 + 500/dt; // low pass filter lol
			fpsCounter.innerHTML = fps;
		}
		var n = circles.length;
		for (var i=0; i<n; i++) {
			circles[i].move(dt/1000);
		}
		
		ctx.clearRect(0,0,600,600);
		for (var i=0; i<n; i++) {
			circles[i].draw();
		}
		setTimeout(loop, 1);
	};
	loop();
	
}; // window.onload	
</script>
</head>
<body>
	<div>FPS: <span id='fps'>0</span></div>
	<canvas id='canvas' height='600' width='600' style='border:1px solid #000'></canvas>
	<p>One thousand circles bouncing against the walls of a square. They're highlighted red whenever they're overlapping another circle.</p>
</body>
</html>
